

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Unprotecting payloads whose keys have been revoked &mdash; ASP.NET 0.0.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../_static/custom.css?v=1" type="text/css" />
  

  
    <link rel="top" title="ASP.NET 0.0.1 documentation" href="../../../index.html"/>
        <link rel="up" title="Consumer APIs" href="index.html"/>
        <link rel="next" title="Configuration" href="../configuration/index.html"/>
        <link rel="prev" title="Limiting the lifetime of protected payloads" href="limited-lifetime-payloads.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> ASP.NET
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../conceptual-overview/index.html">Conceptual Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fundamentals/index.html">Fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/index.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dnx/index.html">.NET Execution Environment (DNX)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../frameworks/index.html">Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data/index.html">Working with Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publishing/index.html">Publishing and Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client-side/index.html">Client-Side Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile/index.html">Mobile</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Security</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../sociallogins.html">Enabling authentication using external providers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../accconfirm.html">Account Confirmation and Password Recovery with ASP.NET Identity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2fa.html">Two-factor authentication with SMS using ASP.NET Identity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../authorization/index.html">Authorization</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Data Protection</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../using-data-protection.html">Getting Started with the Data Protection APIs</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Consumer APIs</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="overview.html">Consumer APIs Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="purpose-strings.html">Purpose Strings</a></li>
<li class="toctree-l4"><a class="reference internal" href="purpose-strings-multitenancy.html">Purpose hierarchy and multi-tenancy</a></li>
<li class="toctree-l4"><a class="reference internal" href="password-hashing.html">Password Hashing</a></li>
<li class="toctree-l4"><a class="reference internal" href="limited-lifetime-payloads.html">Limiting the lifetime of protected payloads</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="">Unprotecting payloads whose keys have been revoked</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../extensibility/index.html">Extensibility APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../implementation/index.html">Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../compatibility/index.html">Compatibility</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../app-secrets.html">Safe Storage of Application Secrets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../anti-request-forgery.html">|stub-icon| Anti-Request Forgery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../open-redirect.html">|stub-icon| Preventing Open Redirect Attacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cross-site-scripting.html">|stub-icon| Preventing Cross-Site Scripting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cors.html">Enabling Cross-Origin Requests (CORS)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../performance/index.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration/index.html">Migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute/index.html">Contribute</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">ASP.NET</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Security</a> &raquo;</li>
      
          <li><a href="../index.html">Data Protection</a> &raquo;</li>
      
          <li><a href="index.html">Consumer APIs</a> &raquo;</li>
      
    <li>Unprotecting payloads whose keys have been revoked</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/security/data-protection/consumer-apis/dangerous-unprotect.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
  <div class="section" id="unprotecting-payloads-whose-keys-have-been-revoked">
<span id="data-protection-consumer-apis-dangerous-unprotect"></span><h1>Unprotecting payloads whose keys have been revoked<a class="headerlink" href="#unprotecting-payloads-whose-keys-have-been-revoked" title="Permalink to this headline">¶</a></h1>
<p>The ASP.NET 5 data protection APIs are not primarily intended for indefinite persistence of confidential payloads. Other technologies like <a class="reference external" href="https://msdn.microsoft.com/en-us/library/windows/desktop/hh706794%28v=vs.85%29.aspx">Windows CNG DPAPI</a> and <a class="reference external" href="https://technet.microsoft.com/en-us/library/jj585024.aspx">Azure Rights Management</a> are more suited to the scenario of indefinite storage, and they have correspondingly strong key management capabilities. That said, there is nothing prohibiting a developer from using the ASP.NET 5 data protection APIs for long-term protection of confidential data. Keys are never removed from the key ring, so IDataProtector.Unprotect can always recover existing payloads as long as the keys are available and valid.</p>
<p>However, an issue arises when the developer tries to unprotect data that has been protected with a revoked key, as IDataProtector.Unprotect will throw an exception in this case. This might be fine for short-lived or transient payloads (like authentication tokens), as these kinds of payloads can easily be recreated by the system, and at worst the site visitor might be required to log in again. But for persisted payloads, having Unprotect throw could lead to unacceptable data loss.</p>
<div class="section" id="ipersisteddataprotector">
<h2>IPersistedDataProtector<a class="headerlink" href="#ipersisteddataprotector" title="Permalink to this headline">¶</a></h2>
<p>To support the scenario of allowing payloads to be unprotected even in the face of revoked keys, the data protection system contains an IPersistedDataProtector type. To get an instance of IPersistedDataProtector, simply get an instance of IDataProtector in the normal fashion and try casting the IDataProtector to IPersistedDataProtector.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Not all IDataProtector instances can be cast to IPersistedDataProtector. Developers should use the C# as operator or similar to avoid runtime exceptions caused by invalid casts, and they should be prepared to handle the failure case appropriately.</p>
</div>
<p>IPersistedDataProtector exposes the following API surface:</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="n">DangerousUnprotect</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">protectedData</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">ignoreRevocationErrors</span><span class="p">,</span>
  <span class="k">out</span> <span class="kt">bool</span> <span class="n">requiresMigration</span><span class="p">,</span> <span class="k">out</span> <span class="kt">bool</span> <span class="n">wasRevoked</span><span class="p">)</span> <span class="p">:</span> <span class="kt">byte</span><span class="p">[]</span>
</pre></div>
</div>
<p>This API takes the protected payload (as a byte array) and returns the unprotected payload. There is no string-based overload. The two out parameters are as follows.</p>
<ul class="simple">
<li>requiresMigration: will be set to true if the key used to protect this payload is no longer the active default key, e.g., the key used to protect this payload is old and a key rolling operation has since taken place. The caller may wish to consider reprotecting the payload depending on his business needs.</li>
<li>wasRevoked: will be set to true if the key used to protect this payload was revoked.</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Exercise extreme caution when passing ignoreRevocationErrors: true to the DangerousUnprotect method. If after calling this method the wasRevoked value is true, then the key used to protect this payload was revoked, and the payload&#8217;s authenticity should be treated as suspect. In this case only continue operating on the unprotected payload if you have some separate assurance that it is authentic, e.g. that it&#8217;s coming from a secure database rather than being sent by an untrusted web client.</p>
</div>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88</pre></div></td><td class="code"><div class="highlight"><pre>using System;
using System.IO;
using System.Text;
using Microsoft.AspNet.DataProtection;
using Microsoft.AspNet.DataProtection.KeyManagement;
using Microsoft.Framework.DependencyInjection;
 
public class Program
{
    public static void Main(string[] args)
    {
        var serviceCollection = new ServiceCollection();
        serviceCollection.AddDataProtection();
        serviceCollection.ConfigureDataProtection(configure =&gt;
        {
            // point at a specific folder and use DPAPI to encrypt keys
            configure.PersistKeysToFileSystem(new DirectoryInfo(@&quot;c:\temp-keys&quot;));
            configure.ProtectKeysWithDpapi();
        });
        var services = serviceCollection.BuildServiceProvider();
 
        // get a protector and perform a protect operation
        var protector = services.GetDataProtector(&quot;Sample.DangerousUnprotect&quot;);
        Console.Write(&quot;Input: &quot;);
        byte[] input = Encoding.UTF8.GetBytes(Console.ReadLine());
        var protectedData = protector.Protect(input);
        Console.WriteLine($&quot;Protected payload: {Convert.ToBase64String(protectedData)}&quot;);
 
        // demonstrate that the payload round-trips properly
        var roundTripped = protector.Unprotect(protectedData);
        Console.WriteLine($&quot;Round-tripped payload: {Encoding.UTF8.GetString(roundTripped)}&quot;);
 
        // get a reference to the key manager and revoke all keys in the key ring
        var keyManager = services.GetService&lt;IKeyManager&gt;();
        Console.WriteLine(&quot;Revoking all keys in the key ring...&quot;);
        keyManager.RevokeAllKeys(DateTimeOffset.Now, &quot;Sample revocation.&quot;);
 
        // try calling Protect - this should throw
        Console.WriteLine(&quot;Calling Unprotect...&quot;);
        try
        {
            var unprotectedPayload = protector.Unprotect(protectedData);
            Console.WriteLine($&quot;Unprotected payload: {Encoding.UTF8.GetString(unprotectedPayload)}&quot;);
        }
        catch (Exception ex)
        {
            Console.WriteLine($&quot;{ex.GetType().Name}: {ex.Message}&quot;);
        }
 
        // try calling DangerousUnprotect
        Console.WriteLine(&quot;Calling DangerousUnprotect...&quot;);
        try
        {
            IPersistedDataProtector persistedProtector = protector as IPersistedDataProtector;
            if (persistedProtector == null)
            {
                throw new Exception(&quot;Can&#39;t call DangerousUnprotect.&quot;);
            }
 
            bool requiresMigration, wasRevoked;
            var unprotectedPayload = persistedProtector.DangerousUnprotect(
                protectedData: protectedData,
                ignoreRevocationErrors: true,
                requiresMigration: out requiresMigration,
                wasRevoked: out wasRevoked);
            Console.WriteLine($&quot;Unprotected payload: {Encoding.UTF8.GetString(unprotectedPayload)}&quot;);
            Console.WriteLine($&quot;Requires migration = {requiresMigration}, was revoked = {wasRevoked}&quot;);
        }
        catch (Exception ex)
        {
            Console.WriteLine($&quot;{ex.GetType().Name}: {ex.Message}&quot;);
        }
    }
}
 
/*
 * SAMPLE OUTPUT
 *
 * Input: Hello!
 * Protected payload: CfDJ8LHIzUCX1ZVBn2BZ...
 * Round-tripped payload: Hello!
 * Revoking all keys in the key ring...
 * Calling Unprotect...
 * CryptographicException: The key {...} has been revoked.
 * Calling DangerousUnprotect...
 * Unprotected payload: Hello!
 * Requires migration = True, was revoked = True
 */
</pre></div>
</td></tr></table></div>
</div>
</div>



  <!-- Helpfulness -->
  <div id="helpful-position"></div>
  <div id="helpful" class="helpfulness-container fixed" style="display:none;">
    <div class="helpfulness">
      <div class="helpfulness-form">
        <h2>Was this page helpful?</h2>
        <span>Your feedback about this content is important. Let us know what you think.</span>
        <a id="helpfulness-btn-yes" href="javascript:;" class="common-btn first">Yes</a>
        <a id="helpfulness-btn-no" href="javascript:;" class="common-btn">No</a>
      </div>
      <div class="helpfulness-form-no" style="display:none;">
        <h2>Was this page helpful?</h2>
        Sorry this wasn't helpful.
        <input type="text" id="txt-helpfulness" placeholder="Please let us know why this wasn't helpful">
        <span id="helpfulness-characters-left">characters remaining</span>
        <a id="helpfulness-btn-submit" href="javascript:;" class="common-btn">Submit</a>
        <a id="helpfulness-btn-skip" href="javascript:;" class="common-btn secondary">Skip this</a>
      </div>
      <a href="javascript:;" class="helpfulness-close">✖</a>
      <div class="messages processing" style="display:none;">
        Sending feedback...
      </div>
      <div class="messages success" style="display:none;">
        Thank you for your feedback!
      </div>
      <div class="messages error" style="display:none;">
        Error during submission!
      </div>
    </div>
  </div>

  <!-- wedc -->
  <noscript>
    <img alt="" width="1" height="1" src="https://c.microsoft.com/trans_pixel.aspx"/>
  </noscript>

  
  <!-- disqus commenting disabled; set disqus_shortname -->
  
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../configuration/index.html" class="btn btn-neutral float-right" title="Configuration" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="limited-lifetime-payloads.html" class="btn btn-neutral" title="Limiting the lifetime of protected payloads" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Microsoft.
      Last updated on Nov 12, 2015.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>